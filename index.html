﻿<!DOCTYPE html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Language" content="zh-cn">
<meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
<title>玻璃幕墙光反射影响预测工具</title>
<script src="jquery-1.10.2.min.js"></script>
<script src="jquery-ui-1.10.3.custom.min.js"></script>
<link rel="stylesheet" type="text/css" href="jquery-ui-1.10.3.custom.min.css">
<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=AIzaSyC8mjYLDLdDSwJJsEzJNKCCGiE_R2RzyK0&sensor=true"></script>
<script src="d3.v3.min.js"></script>
<style>
body {
	margin: 1em 2em;
	background-color: #FBF8EF;
	font-family: 'Helvetica Neue', HelveticaNeue, Helvetica, Arial, sans-serif;
}
h1 {
	font-size: 1.5em;
	color: #0B3861;
	margin-top: 0;
}
h2 { font-size: 1.25em }
p {
    margin: 0.5em 0;
}
#map-canvas {
    height: 500px;
    width: 70%;
}
#tools {
	float: right;
	clear: right;
	width: 25%;
}
.wigtitle{
color:#61380B;
font-weight: bold;
}
.slider {
	width: 80%;
	margin: 0 15px 0;
}
.jquibt{font-size: .8em;}
.jqui{font-size: 12px;}
.info {
    border-bottom: 1px #38C solid;
    margin-bottom: 2em;
}
.num {
	color: #175086;
}
div#simpleSearch {
display: block;
position: relative;
width: 85%;
height: 1.75em;
margin-top: 0.65em;
border: solid 1px #ddd;
border-radius: 4px;
color: black;
background-color: #f9f9f9;
}
div#simpleSearch input#address {
position: absolute;
top: 5%;
left: 0;
width: 90%;
height: 90%;
margin: 0;
padding: 0;
padding-left: 0.2em;
padding-top: 0.2em;
padding-bottom: 0.2em;
outline: none;
border: none;
font-size: 14px;
background-color: transparent;
}
div#simpleSearch button#searchButton {
position: absolute;
width: 10%;
right: 0;
top: 10%;
padding: 0;
padding-top: 0.3em;
padding-bottom: 0.2em;
padding-right: 0.4em;
margin: 0;
border: none;
background-color: transparent;
}
div#simpleSearch button#searchButton > img {
margin: 0;
border: none;
padding: 0;
vertical-align: middle;
}
#radio {
	margin-top: .4em;
}
label[for^='radio'] span:before{
	content:"";
	position:absolute;
	left:.5em;
	top:.5em;
	width:.5em;
	height:1em;
}
label[for='radio1'] span:before{
	background-color:#FF8000;
}
label[for='radio2'] span:before{
	background-color:#A5DF00;
}
label.forrad span{
	text-indent: .5em;
}
#error{
	display:none;
	position:absolute;
	font-size:.8em;
}
a, a:visited {
    text-decoration: none;
    color: #03E;
}
#footer {
	font-size: 0.5em;
	margin: 2em;
}
#chart-svg {
	width: 100%;
	
}
.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}
</style>
<script>
var map;
var markera;
var markerb;
var markerc;
var markerd;
var geocoder;
var visiblemark=false;
var EffectData=new Array(7);
for(var i=0;i<7;i++){
     EffectData[i]=new Array(365);
	 for(var j=0;j<365;j++){
		EffectData[i][j]=new Array(8);
	 };
};
dearth = 12745594;
pi180=0.0174532925199;
function initialize() {
    var mapOptions = {
        zoom: 12,
        center: new google.maps.LatLng(31.231, 121.474),
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        streetViewControl: false
    }
	geocoder = new google.maps.Geocoder();
    google.maps.visualRefresh = true;
    map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
    markera = new google.maps.Marker({
        position: map.getCenter(),
        map: map,
        title: 'A',
        visible: false,
        draggable: true,
    });
    markerb = new google.maps.Marker({
        position: map.getCenter(),
        map: map,
        title: 'B',
        visible: false,
        draggable: true,
    });
    markerc = new google.maps.Marker({
        position: map.getCenter(),
        map: map,
        title: 'C',
        visible: false,
        draggable: true,
    });
    markerd = new google.maps.Marker({
        position: map.getCenter(),
        map: map,
        title: 'D',
        visible: false,
        draggable: true,
    });
    var poly = new google.maps.Polyline({
        path: [markera.getPosition(), markerb.getPosition()],
        map: map,
        strokeColor: "#FF8000",
        strokeOpacity: 1.0,
        strokeWeight: 3,
        visible: false,
    });
    var polyb = new google.maps.Polyline({
        path: [markera.getPosition(), markerb.getPosition()],
        map: map,
        strokeColor: "#A5DF00",
        strokeOpacity: 1.0,
        strokeWeight: 3,
        visible: false,
    });
    google.maps.event.addListener(map, 'click', function (event) {
	if ($("[name='radio']:checked").val()=="wa"){
        if (!markera.getVisible()) {
            markera.setPosition(event.latLng);
            markera.setVisible(true);
        } else if (!markerb.getVisible()) {
            markerb.setPosition(event.latLng);
            markerb.setVisible(true);
            poly.setPath([markera.getPosition(), markerb.getPosition()]);
            poly.setVisible(true);
        } else {
            markera.setPosition(event.latLng);
            poly.setPath([markera.getPosition(), markerb.getPosition()]);
        }
	}else{
        if (!markerc.getVisible()) {
            markerc.setPosition(event.latLng);
            markerc.setVisible(true);
			visiblemark=true;
        } else if (!markerd.getVisible()) {
            markerd.setPosition(event.latLng);
            markerd.setVisible(true);
            polyb.setPath([markerc.getPosition(), markerd.getPosition()]);
            polyb.setVisible(true);
			visiblemark=true;
        } else {
            markerc.setPosition(event.latLng);
            polyb.setPath([markerc.getPosition(), markerd.getPosition()]);
        }
	}
    });
    google.maps.event.addListener(map, 'rightclick', function (event) {
		if ($("[name='radio']:checked").val()=="wa"){
        markerb.setPosition(event.latLng);
        poly.setPath([markera.getPosition(), markerb.getPosition()]);
		}else{
        markerd.setPosition(event.latLng);
        polyb.setPath([markerc.getPosition(), markerd.getPosition()]);
		}
    });
    google.maps.event.addListener(markera, 'position_changed', function () {
        poly.setPath([markera.getPosition(), markerb.getPosition()]);
        $("#distance").text(dist());
    });
    google.maps.event.addListener(markerb, 'position_changed', function () {
        poly.setPath([markera.getPosition(), markerb.getPosition()]);
        $("#distance").text(dist());
    });
    google.maps.event.addListener(markerc, 'position_changed', function () {
        polyb.setPath([markerc.getPosition(), markerd.getPosition()]);
        $("#distanceb").text(distb());
    });
    google.maps.event.addListener(markerd, 'position_changed', function () {
        polyb.setPath([markerc.getPosition(), markerd.getPosition()]);
        $("#distanceb").text(distb());
    });
	$("#radiogroup").change(function(){
	if ($("[name='radio']:checked").val()=="wa"){
	markera.setVisible(true);
	markerb.setVisible(true);
	markerc.setVisible(false);
	markerd.setVisible(false);
	poly.setVisible(true);
	}else{
	markera.setVisible(false);
	markerb.setVisible(false);
	if (visiblemark){
	markerc.setVisible(true);
	markerd.setVisible(true);
	polyb.setVisible(true);
	}
	}
});
}
window.onload = initialize;
  function codeAddress() {
    var saddress = document.getElementById("address").value;
	if (saddress!="") {
    geocoder.geocode( {address: saddress, latLng: map.getCenter()}, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        map.panTo(results[0].geometry.location);
		markera.setPosition(map.getCenter());
		markerb.setPosition(map.getCenter());
		markerc.setPosition(map.getCenter());
		markerd.setPosition(map.getCenter());
      } else {
		$("#errdiv p").text(function (){
		if (status == google.maps.GeocoderStatus.ZERO_RESULTS) {
		return "找不到地址。";
		}else if (status == google.maps.GeocoderStatus.OVER_QUERY_LIMIT) {
		return "超出配额。";
		}else if (status == google.maps.GeocoderStatus.REQUEST_DENIED) {
		return "请求被拒绝。";
		}else if (status == google.maps.GeocoderStatus.INVALID_REQUEST) {
		return "缺少查询内容。";
		}
		});
		$("#error").show();
		$("#error").delay(5000);
		$("#error").fadeOut(500);
      }
    });};
  }
function dist() {
    alat = markera.getPosition().lat() * pi180;
    alng = markera.getPosition().lng() * pi180;
    blat = markerb.getPosition().lat() * pi180;
    blng = markerb.getPosition().lng() * pi180;
    k = Math.sqrt(Math.pow(Math.sin(blat) - Math.sin(alat), 2) + Math.pow(Math.cos(blat) - Math.cos(alat) * Math.cos(Math.abs(alng - blng)), 2) + Math.pow(Math
        .cos(alat) * Math.sin(Math.abs(alng - blng)), 2));
    l = Math.round(dearth * Math.asin(k / 2) * 100) / 100;
	if (l>500){$("#distance").css("color","red")
	}else{$("#distance").css("color","#175086")}; 
    return l;
}
function distb() {
    clat = markerc.getPosition().lat() * pi180;
    clng = markerc.getPosition().lng() * pi180;
    dlat = markerd.getPosition().lat() * pi180;
    dlng = markerd.getPosition().lng() * pi180;
    j = Math.sqrt(Math.pow(Math.sin(clat) - Math.sin(clat), 2) + Math.pow(Math.cos(dlat) - Math.cos(clat) * Math.cos(Math.abs(clng - dlng)), 2) + Math.pow(Math
        .cos(clat) * Math.sin(Math.abs(clng - dlng)), 2));
    s = Math.round(dearth * Math.asin(j / 2) * 100) / 100;
	if (s>500){$("#distanceb").css("color","red")
	}else{$("#distanceb").css("color","#175086")}; 
    return s;
}
$(document).ready(function () {
    $("#wallh").slider({
        orientation: "horizontal",
        range: "min",
        max: 120,
        value: 20,
        slide: function(event, ui) {$("#wallh-n").text( ui.value );},
        change: function(event, ui) {$("#wallh-n").text( ui.value );}
    });
    $("#planeh").slider({
        orientation: "horizontal",
        range: "min",
        max: 100,
        value: 10,
        slide: function(event, ui) {$("#planeh-n").text( ui.value );},
        change: function(event, ui) {$("#planeh-n").text( ui.value );}
    });
});
$(document).ready(function() {
    $("#radio").buttonset();
    $("#button1").button();
    $("#button1").click(function(){CalcData();$("#chart-svg").html("");d3.select("#chart-svg").selectAll("p")
    .data(EffectData)
    .enter()
    .append("p")
    .text(function(d) {return d;});
});
});
function Calc(daynum,time,ala,aln,bla,bln,cla,cln,dla,dln) {
//daynum -> in one year
//time -> 24h, DEG
//ala,aln,bla,bln,cla,cln,dla,dln -> RAD!!!!!
avgla=(ala+bla+cla+dla)/4;
avgln=(aln+bln+cln+dln)/4;
localtime=time+(avgln/pi180-120)/15;
a=Math.PI*2*(daynum-1)/365;
phi=0.006918-0.399912*Math.cos(a)+0.070257*Math.sin(a)-0.006758*Math.cos(2*a)+0.000907*Math.sin(2*a)-0.002697*Math.cos(3*a)+0.001480*Math.sin(3*a);
ho=Math.asin(Math.cos(Math.PI*(localtime-12)*15/180)*Math.cos(avgla)*Math.cos(phi)+Math.sin(avgla)*Math.sin(phi));
alpha=0-Math.asin(-Math.sin(Math.PI*(localtime-12)*15/180)*Math.cos(avgla)/Math.cos(ho));
if (ala-bla!=0){
	n=Math.abs(bla-ala)/(bla-ala)*Math.acos(Math.asin(Math.sqrt(Math.pow((Math.sin(bla)-Math.sin(ala)),2)+Math.pow((Math.cos(bla)-Math.cos(ala)),2))/2)/Math.asin(Math.sqrt(Math.pow((Math.sin(bla)-Math.sin(ala)),2)+Math.pow((Math.cos(bla)-Math.cos(ala)*Math.cos(Math.abs(aln-bln))),2)+Math.pow((Math.cos(ala)*Math.sin(Math.abs(aln-bln))),2))/2))}else{n=0};
if (cla-dla!=0){
	m=Math.abs(dla-cla)/(dla-cla)*Math.acos(Math.asin(Math.sqrt(Math.pow((Math.sin(dla)-Math.sin(cla)),2)+Math.pow((Math.cos(dla)-Math.cos(cla)),2))/2)/Math.asin(Math.sqrt(Math.pow((Math.sin(dla)-Math.sin(cla)),2)+Math.pow((Math.cos(dla)-Math.cos(cla)*Math.cos(Math.abs(cln-dln))),2)+Math.pow((Math.cos(cla)*Math.sin(Math.abs(cln-dln))),2))/2))}else{m=0};
gamma=Math.PI/2-m+2*n-alpha;
if (ho>0){
	theta=Math.acos(Math.abs(Math.cos(gamma)*Math.cos(ho)));
	B=137000*Math.exp(-0.223/Math.sin(ho));
}else{
	return 0;
};
if (theta<Math.PI/12){
	if (B>=2000){return 6;};
}else if (theta>=Math.PI/12 && theta<=Math.PI/6){
	if (B>=2000 && B<4000){
		return 3;
	}else if (B>=4000 && B<6000){
		return 4;
	}else if (B>=4000 && B<6000){
		return 5;
	};
}else if (theta>Math.PI/6){
	return 2;
};
return 1;
}

function CalcData(){
    alat = markera.getPosition().lat() * pi180;
    alng = markera.getPosition().lng() * pi180;
    blat = markerb.getPosition().lat() * pi180;
    blng = markerb.getPosition().lng() * pi180;
    clat = markerc.getPosition().lat() * pi180;
    clng = markerc.getPosition().lng() * pi180;
    dlat = markerd.getPosition().lat() * pi180;
    dlng = markerd.getPosition().lng() * pi180;
	var lastnum=0;
	var count=0;
	for (var i=0;i<365;i++){
		lastnum=0;
		count=0;
		for (var j=0;j<1440;j++){
			nownum=Calc(i,j/60,alat,alng,blat,blng,clat,clng,dlat,dlng);
			if (lastnum!=nownum){
				EffectData[lastnum][i][count]=0.5-j;	//-(j-0.5)
				EffectData[nownum][i][count]=j-0.5;
				count++;
			}
			lastnum=nownum;
		};
	};
}

//d3 here
/*var margin = {top: 20, right: 20, bottom: 30, left: 50},
    width = 960 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

var parseDate = d3.time.format("%y-%b-%d").parse,
    formatPercent = d3.format(".0%");

var x = d3.time.scale()
    .range([0, width]);

var y = d3.scale.linear()
    .range([height, 0]);

var color = d3.scale.category20();

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom");

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left")
    .tickFormat(formatPercent);

var area = d3.svg.area()
    .x(function(d) { return x(d.date); })
    .y0(function(d) { return y(d.y0); })
    .y1(function(d) { return y(d.y0 + d.y); });

var stack = d3.layout.stack()
    .values(function(d) { return d.values; });

var svg = d3.select(".chart-svg").append("svg")
    .data(EffectData)
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
*/


/*d3.select(".chart-svg").selectAll("p")
    .data(EffectData)
    .enter()
    .append("p")
    .text(function(d) { return d; });*/

	
/*d3.tsv("data.tsv", function(error, data) {  color.domain(d3.keys(data[0]).filter(function(key) { return key !== "date"; }));


  data.forEach(function(d) {
    d.date = parseDate(d.date);
  });

  var browsers = stack(color.domain().map(function(name) {
    return {
      name: name,
      values: data.map(function(d) {
        return {date: d.date, y: d[name] / 100};
      })
    };
  }));

  x.domain(d3.extent(data, function(d) { return d.date; }));

  var browser = svg.selectAll(".browser")
      .data(browsers)
    .enter().append("g")
      .attr("class", "browser");

  browser.append("path")
      .attr("class", "area")
      .attr("d", function(d) { return area(d.values); })
      .style("fill", function(d) { return color(d.name); });

  browser.append("text")
      .datum(function(d) { return {name: d.name, value: d.values[d.values.length - 1]}; })
      .attr("transform", function(d) { return "translate(" + x(d.value.date) + "," + y(d.value.y0 + d.value.y / 2) + ")"; })
      .attr("x", -6)
      .attr("dy", ".35em")
      .text(function(d) { return d.name; });

  svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);

  svg.append("g")
      .attr("class", "y axis")
      .call(yAxis);
});*/

</script>
</head>
<body>
  <!--[if lt IE 8]>
  <div style='border: 1px solid #FF4000; background: #FFDA66; text-align: center; clear: both; height: 60px; position: relative;'>
    <div style='position: absolute; right: 3px; top: 3px; font-family: courier new; font-weight: bold;'><a href='#' onclick='javascript:this.parentNode.parentNode.style.display="none"; return false;'>×</a></div>
    <div style='margin: 0 auto; text-align: left; padding: 0; overflow: hidden; color: black; text-align:center'>
        <p style='font-size: 14px; font-weight: bold; margin-top: 12px; text-indent:0;'>您正在使用一款过时的浏览器。</p>
        <p style='font-size: 12px; margin-top: 6px; line-height: 12px; text-indent:0;'>请升级您的浏览器来获得更好的浏览体验。</p>
    </div>
  </div>
  <![endif]-->
<h1>玻璃幕墙光反射影响预测工具</h1>
<div class="info">
<p>在地图上通过左右键点击或移动标识来确定目标墙体的位置。</p>
<p>时区默认UTC+8时区。因为未考虑气候、地形、建筑、房屋实际结构，计算结果为预计最大值，仅供参考。</p></div>
<div id="app">
<div id="tools">
<form id="searchform" onsubmit="codeAddress();return false;">
<div id="simpleSearch">
<input name="search" placeholder="查找地址" title="查找地址" id="address">
<button type="submit" name="button" title="查找地址" id="searchButton" onclick="codeAddress()">
<img src="images/search-ltr.png" alt="查找地址" width="12" height="13"></button>
</div>
</form>
<h2>计算设置</h2>
<p><form id="radiogroup">
  <span class="wigtitle">更改地图上墙面：</span>
  <div class="jquibt" id="radio">
    <input type="radio" id="radio1" name="radio" value="wa" checked="checked"><label class="forrad" for="radio1">玻璃幕墙</label>
    <input type="radio" id="radio2" name="radio" value="wb"><label class="forrad" for="radio2">受照射墙面</label>
  </div>
</form></p>
<p><span class="wigtitle">玻璃幕墙宽：</span><span id="distance" class="num">0</span>米</p>
<p><span class="wigtitle">受照射墙宽：</span><span id="distanceb" class="num">0</span>米</p>
<p><span class="wigtitle">玻璃幕墙高度：</span><span id="wallh-n" class="num">20</span>米<div id="wallh" class="slider jqui"></div>
</p>
<p><span class="wigtitle">受照射面高度：</span><span id="planeh-n" class="num">10</span>米<div id="planeh" class="slider jqui"></div>
</p>
<p><span class="wigtitle">距离：</span><span class="num">0</span>米</p>
<p><div class="jquibt" id="button">
    <button id="button1" name="button">计算</button>
</div>
</p>
<div class="ui-widget" id="errdiv">
	<div class="ui-state-highlight ui-corner-all" style="padding: 0 .7em;" id="error">
		<p></p>
	</div>
</div>
</div>
<div id="map-canvas"></div>
<div id="chart-svg">
</div>
</div>
<!--<div id="footer">
制作：XXX，网站空间：Gumble
</div>-->
</body>
</html>
﻿<!DOCTYPE html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Language" content="zh-cn">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- , maximum-scale=1.0 -->
<title>玻璃幕墙光反射影响预测工具</title>
<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=AIzaSyC8mjYLDLdDSwJJsEzJNKCCGiE_R2RzyK0&sensor=true"></script>
<script src="jquery-1.10.2.min.js"></script>
<script src="jquery-ui-1.10.4.custom.min.js"></script>
<link rel="stylesheet" type="text/css" href="jquery-ui-1.10.4.custom.min.css">
<script src="d3.v3.min.js"></script>
<style>
body {
	margin: .5em 2em;
	background-color: #FBF8EF;
	font-family: 'Helvetica Neue', HelveticaNeue, Helvetica, Arial, sans-serif;
}
header{
	margin-top: 0;
	margin-bottom: 1em;
}
h1 {
	font-size: 1.5em;
	color: #0B3861;
	display: inline;
	padding-left: .1em;
	font-family: 'Droid Sans Fallback', STHeiTi, '微软雅黑', '黑体', SimHei, sans-serif;
}
h2 { font-size: 1.25em }
p {
	margin: 0.5em 0;
}
#map-canvas {
	position: relative;
	height: 500px;
	width: 58%;
	margin-top: 1em;
}
#graph {
	float: right;
	clear: right;
	width: 40%;
	margin-top: 1em;
}
#chart-svg {
	height: 320px;
}
#chart-legend {
	padding-left: 1em;
}
#error{
	display:none;
	position:relative;
	font-size:.8em;
}
#errdiv{margin: 2em 1em;position:relative;}
.wigtitle{
	color:#61380B;
	font-weight: bold;
}
.jquibt{
	font-size: .8em;
	-webkit-touch-callout: none;
	-webkit-user-select: none;
	-khtml-user-select: none;
	-moz-user-select: none;
	-ms-user-select: none;
	user-select: none;
}
.ui-spinner, .ui-slider{font-size: .875em;margin: 0 .25em 0;}
.ui-spinner-input{width:1.75em; }
.slider {
	display: inline-block;
	width: 9%;
}
.unit{padding-right:1em}
.info {
	margin-bottom: 2em;
}
.num {
	color: #175086;
}
#simpleSearch {
	display: block;
	position: relative;
	float: right;
	width: 14em;
	height: 1.75em;
	margin: 1em 3em 1em 1em;
	border: solid 1px #ddd;
	border-radius: 4px;
	color: black;
	background-color: #f9f9f9;
}
#simpleSearch #address {
	position: absolute;
	top: 0;
	left: 0;
	width: 90%;
	height: 90%;
	margin: 0;
	padding: 0;
	padding-left: 1em;
	padding-top: 0.2em;
	padding-bottom: 0.2em;
	outline: none;
	border: none;
	font-size: 14px;
	background-color: transparent;
}
#simpleSearch #searchButton {
	position: absolute;
	width: 10%;
	right: 0;
	top: 8%;
	padding: 0;
	padding-top: 0.3em;
	padding-bottom: 0.2em;
	padding-right: 0.4em;
	margin: 0;
	border: none;
	background-color: transparent;
}
#imgsearch {
	margin: 0;
	border: none;
	padding: 0;
	vertical-align: middle;
}
#tools .slidergroup{line-height:1.5em;}
#radiogroup{margin-bottom:.5em;}
#radio {
	margin-top: .4em;
	margin-left: 1em;
	display: inline-block;
}
#lbradio1 span:before,#lbradio2 span:before,#btnturnw:before{
	content:"";
	position:absolute;
	left:.5em;
	top:.6em;
	width:.5em;
	height:1em;
}
#lbradio1 span:before, .clr1:before{
	background-color:#FF8000;
}
#lbradio2 span:before, .clr2:before{
	background-color:#0080FF;
}
label.forrad span, #btnturn span{
	text-indent: .5em;
}
#button{
	margin: 2em 1em;
}
a, a:visited {
	text-decoration: none;
	color: #03E;
}
footer {
	font-size: .875em;
	margin: 2em 1em;
	padding-top: .5em;
	border-top: 1px #38C solid;
}
.finfo{
	color: #333;
	text-align: center;
}
.grid path {display: none}
.axis path, .axis line{
	fill: none;
	stroke: #000;
	stroke-width: 1;
	shape-rendering: crispEdges;
}
.axis text{
	font-size: 0.75em;
	-webkit-touch-callout: none;
	-webkit-user-select: none;
	-khtml-user-select: none;
	-moz-user-select: none;
	-ms-user-select: none;
	user-select: none;
}
.grid line{
	fill: none;
	shape-rendering: crispEdges;
	stroke: white;
	stroke-width: 1;
	opacity: 0.4;
}
.tpointer{
  fill: none;
  stroke: #0B3861;
  shape-rendering: crispEdges;
  stroke-width:2;
  stroke-opacity:1
}
</style>
<script>
var map;
var markera;
var markerb;
var markerc;
var markerd;
var poly,polyb;
var geocoder;
var visiblemark=false;

//var Palette=["#9edae5","#1FB638","#1f77b4","#e377c2","#ff7f0e","#d62728"];//#06ADFF
var Palette=["#9edae5","#AEFF5C","#FFD34D","#ff7f0e","#e377c2","#d62728"];
var efname=["无","可接受","轻微影响","有影响","强影响","严重影响"];
var dearth = 12745594;
var pi180 = 0.0174532925199;
var timeoutID = 0;
var h = 320, w=400;
var padding = 20;
var lineHeight = 30;
var rho = 0.15;
var midleTime = 0;
var idleInterval = -1;
var xScale, yScale, xrevScale, yrevScale;
var pab1;
var nowcoord=[0,0];
var mouseDownOnElement=false;
function initialize() {
	var mapOptions = {
		zoom: 12,
		center: new google.maps.LatLng(31.231, 121.474),
		mapTypeId: google.maps.MapTypeId.ROADMAP,
		streetViewControl: false
	}
	geocoder = new google.maps.Geocoder();
	google.maps.visualRefresh = true;
	map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
	markera = new google.maps.Marker({
		position: map.getCenter(),
		map: map,
		title: 'A',
		visible: false,
		draggable: true
	});
	markerb = new google.maps.Marker({
		position: map.getCenter(),
		map: map,
		title: 'B',
		visible: false,
		draggable: true
	});
	markerc = new google.maps.Marker({
		position: map.getCenter(),
		map: map,
		title: 'C',
		visible: false,
		draggable: true
	});
	markerd = new google.maps.Marker({
		position: map.getCenter(),
		map: map,
		title: 'D',
		visible: false,
		draggable: true
	});
	poly = new google.maps.Polyline({
		path: [markera.getPosition(), markerb.getPosition()],
		map: map,
		strokeColor: "#FF8000",
		strokeOpacity: 1.0,
		strokeWeight: 3,
		visible: false,
		icons: [{icon: {path: 'M 0,0 2,2', strokeOpacity: 1, strokeWeight: 2},
			offset: '5px', repeat: '10px'}]
	});
	polyb = new google.maps.Polyline({
		path: [markera.getPosition(), markerb.getPosition()],
		map: map,
		strokeColor: "#0080FF",
		strokeOpacity: 1.0,
		strokeWeight: 3,
		visible: false,
		icons: [{icon: {path: 'M 0,0 2,2', strokeOpacity: 1, strokeWeight: 2},
			offset: '5px', repeat: '10px'},
			{icon: {path: 'M -1.5,-2 1.5,-2 1.5,2 -1.5,2 Z', fillColor: "#FF66D9", fillOpacity: 0.8, strokeWeight: 0},
			offset: '50%'}]
	});
	pab1=new google.maps.Polygon({
		path: [markera.getPosition(), 
		markerb.getPosition(),
		markerc.getPosition(),
		markerd.getPosition()],
		fillColor: "#FF8000",
		fillOpacity: 0.5,
		strokeWeight: 0,
		visible: false,
		map: map,
	});
	google.maps.event.addListener(map, 'click', function (event) {
	if ($("#radio1").is(':checked')){
		if (!markera.getVisible()) {
			markera.setPosition(event.latLng);
			markera.setVisible(true);
		} else if (!markerb.getVisible()) {
			markerb.setPosition(event.latLng);
			markerb.setVisible(true);
			poly.setPath([markera.getPosition(), markerb.getPosition()]);
			poly.setVisible(true);
		} else {
			markera.setPosition(event.latLng);
			poly.setPath([markera.getPosition(), markerb.getPosition()]);
			
		}
	}else{
		if (!markerc.getVisible()) {
			markerc.setPosition(event.latLng);
			markerc.setVisible(true);
			visiblemark=true;
		} else if (!markerd.getVisible()) {
			markerd.setPosition(event.latLng);
			markerd.setVisible(true);
			polyb.setPath([markerc.getPosition(), markerd.getPosition()]);
			polyb.setVisible(true);
			visiblemark=true;
		} else {
			markerc.setPosition(event.latLng);
			polyb.setPath([markerc.getPosition(), markerd.getPosition()]);
		}
	}
	});
	google.maps.event.addListener(map, 'rightclick', function (event) {
		if ($("#radio1").is(':checked')){
		markerb.setPosition(event.latLng);
		poly.setPath([markera.getPosition(), markerb.getPosition()]);
		}else{
		markerd.setPosition(event.latLng);
		polyb.setPath([markerc.getPosition(), markerd.getPosition()]);
		}
	});
	google.maps.event.addListener(markera, 'position_changed', function () {
		poly.setPath([markera.getPosition(), markerb.getPosition()]);
		$("#distance").html(dist());AutoDraw();
	});
	google.maps.event.addListener(markerb, 'position_changed', function () {
		poly.setPath([markera.getPosition(), markerb.getPosition()]);
		$("#distance").html(dist());AutoDraw();
	});
	google.maps.event.addListener(markerc, 'position_changed', function () {
		polyb.setPath([markerc.getPosition(), markerd.getPosition()]);
		$("#distanceb").html(distb());AutoDraw();
	});
	google.maps.event.addListener(markerd, 'position_changed', function () {
		polyb.setPath([markerc.getPosition(), markerd.getPosition()]);
		$("#distanceb").html(distb());AutoDraw();
	});
	$("#radiogroup").change(function(){ChangeMarker();});
}
function ChangeMarker(){
	if ($("#radio1").is(':checked')){
		markera.setVisible(true);
		markerb.setVisible(true);
		markerc.setVisible(false);
		markerd.setVisible(false);
		poly.setVisible(true);
	}else{
		markera.setVisible(false);
		markerb.setVisible(false);
		if (visiblemark){
			markerc.setVisible(true);
			markerd.setVisible(true);
			polyb.setVisible(true);
		}
	}
}
function codeAddress() {
	var saddress = document.getElementById("address").value;
	if (saddress!="") {
	geocoder.geocode({address: saddress, location: map.getCenter()}, function(results, status) {
	  if (status == google.maps.GeocoderStatus.OK) {
		map.panTo(results[0].geometry.location);
		if (map.getZoom()<16){map.setZoom(17)};
		markera.setPosition(map.getCenter());
		markerb.setPosition(map.getCenter());
		markerc.setPosition(map.getCenter());
		markerd.setPosition(map.getCenter());
		$("#errdiv p").text(function (){return "找到："+ results[0].formatted_address;})
		$("#error").show();
		$("#error").delay(2000);
		$("#error").fadeOut(500);
	  } else {
		$("#errdiv p").text(function (){
		if (status == google.maps.GeocoderStatus.ZERO_RESULTS) {
		return "找不到地址。";
		}else if (status == google.maps.GeocoderStatus.OVER_QUERY_LIMIT) {
		return "超出配额。";
		}else if (status == google.maps.GeocoderStatus.REQUEST_DENIED) {
		return "请求被拒绝。";
		}else if (status == google.maps.GeocoderStatus.INVALID_REQUEST) {
		return "查询内容错误。";
		}else{return "连接错误。";}
		});
		$("#error").show();
		$("#error").delay(7500);
		$("#error").fadeOut(500);
	  }
	});};
}
function dist() {
	var alat = markera.getPosition().lat() * pi180;
	var alng = markera.getPosition().lng() * pi180;
	var blat = markerb.getPosition().lat() * pi180;
	var blng = markerb.getPosition().lng() * pi180;
	var k = Math.sqrt(Math.pow(Math.sin(blat) - Math.sin(alat), 2) + Math.pow(Math.cos(blat) - Math.cos(alat) * Math.cos(Math.abs(alng - blng)), 2) + Math.pow(Math.cos(alat) * Math.sin(Math.abs(alng - blng)), 2));
	var l = dearth * Math.asin(k / 2);
	if (l>200){$("#distance").css("color","red")
	}else{$("#distance").css("color","#175086")}; 
	return Math.round(l);
}
function distb() {
	var clat = markerc.getPosition().lat() * pi180;
	var clng = markerc.getPosition().lng() * pi180;
	var dlat = markerd.getPosition().lat() * pi180;
	var dlng = markerd.getPosition().lng() * pi180;
	var j = Math.sqrt(Math.pow(Math.sin(dlat) - Math.sin(clat), 2) + Math.pow(Math.cos(dlat) - Math.cos(clat) * Math.cos(Math.abs(clng - dlng)), 2) + Math.pow(Math.cos(clat) * Math.sin(Math.abs(clng - dlng)), 2));
	var s = dearth * Math.asin(j / 2);
	if (s>75){$("#distanceb").css("color","red")
	}else{$("#distanceb").css("color","#175086")}; 
	return Math.round(s);
}
function pointInPolygon(x,y,polyX,polyY) {
	var polySides=4;
	var i, j=polySides-1;
	var oddNodes=false;
	for (i=0; i<polySides; i++) {
	if ((polyY[i]< y && polyY[j]>=y
	||   polyY[j]< y && polyY[i]>=y)
	&&  (polyX[i]<=x || polyX[j]<=x)) {
	  oddNodes^=(polyX[i]+(y-polyY[i])/(polyY[j]-polyY[i])*(polyX[j]-polyX[i])<x);}
	j=i; }
	return oddNodes;
}

function Calc(daynum,time,ala,aln,bla,bln,cla,cln,dla,dln,Hg,Hp,lw,draw) {
//daynum -> in one year
//time -> 24h, DEG
//ala,aln,bla,bln,cla,cln,dla,dln -> RAD!!!!!
$("#testout").html(ala+","+aln+","+bla+","+bln+","+cla+","+cln+","+dla+","+dln+","+Hg+","+Hp+","+lw)
var avgla=(ala+bla+cla+dla)/4;
var avgln=(aln+bln+cln+dln)/4;
var localtime=time+(avgln/pi180-120)/15;
var a=Math.PI*2*(daynum+localtime/24)/365;
var phi=0.006918-0.399912*Math.cos(a)+0.070257*Math.sin(a)-0.006758*Math.cos(2*a)+0.000907*Math.sin(2*a)-0.002697*Math.cos(3*a)+0.001480*Math.sin(3*a);
var ho=Math.asin(Math.cos(Math.PI*(localtime-12)*15/180)*Math.cos(avgla)*Math.cos(phi)+Math.sin(avgla)*Math.sin(phi));
if (ho>0){
	var cosA=(Math.sin(ho)*Math.sin(avgla)-Math.sin(phi))/Math.cos(ho)/Math.cos(avgla);
	if (localtime>=12){alpha=Math.acos(cosA)}else{alpha=-Math.acos(cosA)};
	if (ala!=bla){
		n=Math.acos(Math.asin(Math.sqrt(Math.pow((Math.sin(bla)-Math.sin(ala)),2)+Math.pow((Math.cos(bla)-Math.cos(ala)),2))/2)/Math.asin(Math.sqrt(Math.pow((Math.sin(bla)-Math.sin(ala)),2)+Math.pow((Math.cos(bla)-Math.cos(ala)*Math.cos(Math.abs(aln-bln))),2)+Math.pow((Math.cos(ala)*Math.sin(Math.abs(aln-bln))),2))/2));
	}else{n=0};
	if (ala<bla){n=Math.PI-n}; if (aln<bln){n=-n};
	if (Math.sin(alpha-n)>0){if(draw){return -2}else{return 0};}
	if (cla!=dla){
		m=Math.acos(Math.asin(Math.sqrt(Math.pow((Math.sin(dla)-Math.sin(cla)),2)+Math.pow((Math.cos(dla)-Math.cos(cla)),2))/2)/Math.asin(Math.sqrt(Math.pow((Math.sin(dla)-Math.sin(cla)),2)+Math.pow((Math.cos(dla)-Math.cos(cla)*Math.cos(Math.abs(cln-dln))),2)+Math.pow((Math.cos(cla)*Math.sin(Math.abs(cln-dln))),2))/2));
	}else{m=0};
	if (cla<dla){m=Math.PI-m}; if (cln<dln){m=-m};
	mu=2*n-alpha;
	L=Hg/Math.tan(ho);
	ala2=ala-(L*Math.cos(Math.PI-mu)*2/dearth);
	aln2=aln+(L*Math.sin(Math.PI-mu)*2/dearth);
	bla2=bla-(L*Math.cos(Math.PI-mu)*2/dearth);
	bln2=bln+(L*Math.sin(Math.PI-mu)*2/dearth);
	if (draw){lineGraph(ala,aln,ala2,aln2,bla2,bln2,bla,bln);}
	if (Math.sin(mu-m)>0){return 0;};
	x1=dearth*Math.asin(Math.sqrt(Math.pow(Math.sin(bla)-Math.sin(ala),2)+Math.pow(Math.cos(bla)-Math.cos(ala),2))/2);
	y1=dearth*Math.asin(Math.sqrt(Math.pow(Math.cos(bla)-Math.cos(bla)*Math.cos(Math.abs(aln-bln)),2)+Math.pow(Math.cos(bla)*Math.sin(Math.abs(aln-bln)),2))/2);
	x2=dearth*Math.asin(Math.sqrt(Math.pow(Math.sin(cla)-Math.sin(ala),2)+Math.pow(Math.cos(cla)-Math.cos(ala),2))/2);
	y2=dearth*Math.asin(Math.sqrt(Math.pow(Math.cos(cla)-Math.cos(cla)*Math.cos(Math.abs(aln-cln)),2)+Math.pow(Math.cos(cla)*Math.sin(Math.abs(aln-cln)),2))/2);
	x3=dearth*Math.asin(Math.sqrt(Math.pow(Math.sin(dla)-Math.sin(ala),2)+Math.pow(Math.cos(dla)-Math.cos(ala),2))/2);
	y3=dearth*Math.asin(Math.sqrt(Math.pow(Math.cos(dla)-Math.cos(dla)*Math.cos(Math.abs(aln-dln)),2)+Math.pow(Math.cos(dla)*Math.sin(Math.abs(aln-dln)),2))/2);
	if (aln>bln){y1=-y1}; if (ala<bla){x1=-x1};
	if (aln>cln){y2=-y2}; if (ala<cla){x2=-x2};
	if (aln>dln){y3=-y3}; if (ala<dla){x3=-x3};

	ela=(cla+dla)/2;
	eln=(cln+dln)/2;
	x4=dearth*Math.asin(Math.sqrt(Math.pow(Math.sin(ela)-Math.sin(ala),2)+Math.pow(Math.cos(ela)-Math.cos(ala),2))/2);
	y4=dearth*Math.asin(Math.sqrt(Math.pow(Math.cos(ela)-Math.cos(ela)*Math.cos(Math.abs(aln-eln)),2)+Math.pow(Math.cos(ela)*Math.sin(Math.abs(aln-eln)),2))/2);
	x5=(y4-Math.tan(Math.PI-mu))/(y1/x1-Math.tan(Math.PI-mu));
	y5=(y4-Math.tan(Math.PI-mu))*y1/((y1/x1-Math.tan(Math.PI-mu))*x1);
	d=Math.sqrt(Math.pow(x4-x5,2)+Math.pow(y4-y5,2));
	hmax=Math.tan(ho)*(L-d);
	if (hmax<Hp){return 0};
	xa=L*Math.cos(Math.PI-mu);
	xb=x1+L*Math.cos(Math.PI-mu);
	ya=L*Math.sin(Math.PI-mu);
	yb=y1+L*Math.sin(Math.PI-mu);
	if (!pointInPolygon((x3*lw+x2*(100-lw))/100,(y3*lw+y2*(100-lw))/100,[0,xa,xb,x1],[0,ya,yb,y1])){return 0};
	gamma=-Math.PI/2+m-2*n+alpha;
	lambda=Math.acos(Math.abs(Math.cos(gamma)*Math.cos(ho)));
	B=rho*137000*Math.exp(-0.223/Math.sin(ho))/Math.PI;
}else{
	return -1;
};
if (lambda<Math.PI/12){
	if (B>=2000){return 5;};
}else if (lambda>=Math.PI/12 && lambda<=Math.PI/6){
	if (B>=2000 && B<4000){
		return 2;
	}else if (B>=4000 && B<6000){
		return 3;
	}else if (B>=6000){
		return 4;
	};
}else if (lambda>Math.PI/6){
	return 1;
};
return 0;
}
function lineGraph(ala,aln,ala2,aln2,bla2,bln2,bla,bln){
	if (visiblemark){
	pab1.setOptions({
		path: [new google.maps.LatLng(ala/pi180, aln/pi180), 
		new google.maps.LatLng(ala2/pi180, aln2/pi180),
		new google.maps.LatLng(bla2/pi180, bln2/pi180),
		new google.maps.LatLng(bla/pi180, bln/pi180)],
		visible: false,
	});}
}
function timerIncrement() {
	midleTime++;
	if (midleTime == 5) { // 500ms
		DrawLine(nowcoord,mouseDownOnElement);
		DrawChart(3,3);
	}else if (midleTime > 50){
		clearInterval(idleInterval);
		idleInterval=-1;
		midleTime=0;
		DrawLine(nowcoord,mouseDownOnElement);
		DrawChart(2,1);
	}
}
function AutoDraw(){
	if (visiblemark){
	midleTime=0;
	//pab1.setOptions({visible: false});
	DrawLine(nowcoord,mouseDownOnElement);
	if (idleInterval==-1){idleInterval = setInterval(timerIncrement, 100)
	};
	//timeoutIDb=setTimeout("AutoRedraw();timeoutIDb=-1",500);
	};
};
function AutoRedraw(){
	if (visiblemark){
	midleTime=4;
	//pab1.setOptions({visible: false});
	DrawLine(nowcoord,mouseDownOnElement);
	if (idleInterval==-1){idleInterval = setInterval(timerIncrement, 100)
	};
	//timeoutID=setTimeout("DrawChart(1,1);timeoutID=-1",2000);
	};
};
function DrawChart(densityx,densityy){
	/*if (pab1.length!=0){
	for (k = 0; k < pab1.length; k++){pab1[k].setMap(null);};
	pab1.length = 0;pab1=[]}*/

	var EffectData=new Array(6);
	for(i=0;i<6;i++){
		 EffectData[i]=[[]];
	};
	var EffectDataEnd=new Array(6);
	for(i=0;i<6;i++){
		 EffectDataEnd[i]=[[]];
	};
	alat = markera.getPosition().lat() * pi180;
	alng = markera.getPosition().lng() * pi180;
	blat = markerb.getPosition().lat() * pi180;
	blng = markerb.getPosition().lng() * pi180;
	clat = markerc.getPosition().lat() * pi180;
	clng = markerc.getPosition().lng() * pi180;
	dlat = markerd.getPosition().lat() * pi180;
	dlng = markerd.getPosition().lng() * pi180;

	var k = Math.sqrt(Math.pow(Math.sin((clat+dlat)/2) - Math.sin((alat+blat)/2), 2) + Math.pow(Math.cos((clat+dlat)/2) - Math.cos((alat+blat)/2) * Math.cos(Math.abs((alng+blng)/2 - (clng+dlng)/2)), 2) + Math.pow(Math.cos((alat+blat)/2) * Math.sin(Math.abs((alng+blng)/2 - (clng+dlng)/2)), 2));
	var l = Math.round(dearth * Math.asin(k / 2) * 100) / 100;
	$("#grapharea").empty();
	if (l>1500){for(i=0;i<6;i++){$("#tp"+i).text("")};return 0}; 
	if (dist()>200 || distb()>75){for(i=0;i<6;i++){$("#tp"+i).text("")};return 0}; 

	//Create scale functions
	var graph = d3.select("#grapharea");
	var lineFunction = d3.svg.line()
					   .x(function(d) {return xScale(d[0]);})
					   .y(function(d) {return yScale(d[1]);})
					   .interpolate("linear-closed");
	h1 = $("#wallh").spinner("value")*3;
	h2 = $("#planeh").spinner("value")*3;
	l2 = $("#window").slider("value");
	var lastnum=-1;
	var nownum=-1;
	var lastcount=[0,0,0,0,0,0];
	var closeda=[0,0,0,0,0,0];
	var sumup=[0,0,0,0,0,0];
	var nowtime=[[],[],[],[],[],[]];
	var nowend=[[],[],[],[],[],[]];
	var addcount=0;
	var opened=false;
	i=0;
	while (i<365){
		nowtime=[[],[],[],[],[],[]];
		nowend=[[],[],[],[],[],[]];
		lastnum=-1;j=0;
		while (j<1440){
			nownum=Calc(i,j/60,alat,alng,blat,blng,clat,clng,dlat,dlng,h1,h2,l2,false);
			if (nownum!=-1){if(i==364){
				sumup[nownum]-=densityx*(365%densityy)
				}else{sumup[nownum]+=densityx*densityy}};
			if (lastnum!=nownum){
				if (lastnum!=-1){nowend[lastnum].push(j-densityx/2)};
				if (nownum!=-1){nowtime[nownum].push(j-densityx/2);opened=true;}
					else{opened=false};
			}
			lastnum=nownum;
			if (j!=1439 && j+densityx>1439){j=1439}else{j+=densityx}
		};
		if (opened){nowend[lastnum].push(1439);}
		for (j=0;j<6;j++){
			if (nowtime[j].length!=lastcount[j]){
				addcount=lastcount[j]+nowtime[j].length;
				if (i>0){closeda[j]+=lastcount[j];}
				for (k=0;k<addcount;k++){
					EffectData[j].push(new Array());
					EffectDataEnd[j].push(new Array());
				}
			}
			if (nowtime[j].length!=lastcount[j] && closeda[j]>0){
				if (EffectDataEnd[j][closeda[j]-1].length>0){
					for (k=0;k<lastcount[j];k++){
						EffectData[j][closeda[j]-lastcount[j]+k][EffectData[j][closeda[j]-lastcount[j]+k].length-1][1]+=densityy/2;
						EffectDataEnd[j][closeda[j]-lastcount[j]+k][EffectDataEnd[j][closeda[j]-lastcount[j]+k].length-1][1]+=densityy/2;
					}
					for (k=0;k<nowtime[j].length;k++){
						EffectData[j][closeda[j]+k].push([nowtime[j][k],i-densityy/2]);
						EffectDataEnd[j][closeda[j]+k].push([nowend[j][k],i-densityy/2]);
					}
				}
			}else{
			for (k=0;k<nowtime[j].length;k++){
				EffectData[j][closeda[j]+k].push([nowtime[j][k],i]);
				EffectDataEnd[j][closeda[j]+k].push([nowend[j][k],i]);
			}}
			lastcount[j]=nowtime[j].length;
		};
		if (i!=364 && i+densityy>364){i=364}else{i+=densityy}
	};
	for(i=0;i<6;i++){
		for (j=0;j<EffectData[i].length;j++){
			EffectData[i][j]=EffectData[i][j].concat(EffectDataEnd[i][j].reverse());
			if (EffectData[i][j].length>1){
			graph.append("path")
			.attr("d", lineFunction(EffectData[i][j]))
			.attr("fill", Palette[i])
			.attr("stroke", Palette[i])
			.attr("stroke-width", 1);}
		}
	}
	//var sumall=d3.sum(sumup);
	for(i=0;i<6;i++){
		//$("#tp"+i).text(Math.round(10000*sumup[i]/sumall)/100 + "%");
		$("#tp"+i).text(Math.round(sumup[i]/60) + "h");
	};
}
function DrawLine(coord,mouse){
	if (coord[0]>padding*1.5 && coord[0]<w-padding*1.5
		&& coord[1]>padding && coord[1]<h - padding){
		mouseDownOnElement=mouse;
		ala = markera.getPosition().lat() * pi180;
		aln = markera.getPosition().lng() * pi180;
		bla = markerb.getPosition().lat() * pi180;
		bln = markerb.getPosition().lng() * pi180;
		cla = markerc.getPosition().lat() * pi180;
		cln = markerc.getPosition().lng() * pi180;
		dla = markerd.getPosition().lat() * pi180;
		dln = markerd.getPosition().lng() * pi180;
		$("#tpoint").attr("transform","translate("+coord[0]+","+coord[1]+")");
		val=Calc(Math.floor(yrevScale(coord[1])),xrevScale(coord[0])/60,ala,aln,bla,bln,cla,cln,dla,dln,$("#wallh").spinner("value")*3,$("#planeh").spinner("value")*3,$("#window").slider("value"),true)
		if (val>-1){
		pab1.setOptions({fillColor: Palette[val],visible: true})
		}else{pab1.setOptions({visible: false})}
	}
}
$(document).ready(function() {
if ($(document.body).width()>900){
	w = $(document.body).width() * 0.39;
	var lgsvg = d3.select("#chart-legend").append("svg").attr("width", w).attr("height", 120);
	lgsvg.append("g").selectAll("rect")
		.data(Palette.slice(0,3))
		.enter()
		.append("rect")
		.attr("x", 2)
		.attr("y", function(d,i) {return i*lineHeight;})
		.attr("width", 30)
		.attr("height", 20)
		.attr("fill", function(d) {return d;});
	lgsvg.append("g").selectAll("text")
		.data(efname.slice(0,3))
		.enter()
		.append("text")
		.attr("x", 40)
		.attr("y", function(d,i) {return i*lineHeight+16;})
		.style("font-size","16px")
		.text(function(d) {return d;});
	lgsvg.append("g").selectAll("rect")
		.data(Palette.slice(3,6))
		.enter()
		.append("rect")
		.attr("x", w*.45+2)
		.attr("y", function(d,i) {return i*lineHeight;})
		.attr("width", 30)
		.attr("height", 20)
		.attr("fill", function(d) {return d;});
	lgsvg.append("g").selectAll("text")
		.data(efname.slice(3,6))
		.enter()
		.append("text")
		.attr("x", w*.45+40)
		.attr("y", function(d,i) {return i*lineHeight+16;})
		.style("font-size","16px")
		.text(function(d) {return d;});
	lgsvg.append("g").attr("id", "lgpercent");
	lgsvg.append("g").attr("id", "lgpercent2");
	lgsvg.select("#lgpercent").selectAll("text")
		.data(new Array(3))
		.enter()
		.append("text")
		.attr("id",function(d,i) {return "tp" + i;})
		.attr("x", 116)
		.attr("y", function(d,i) {return i*lineHeight+16;})
		.style("font-size","16px")
		.style("fill","#175086")
		.text(function(d) {return "";});
	lgsvg.select("#lgpercent2").selectAll("text")
		.data(new Array(3))
		.enter()
		.append("text")
		.attr("id",function(d,i) {return "tp" + (i+3);})
		.attr("x", w*.45+116)
		.attr("y", function(d,i) {return i*lineHeight+16;})
		.style("font-size","16px")
		.style("fill","#175086")
		.text(function(d) {return "";});
	lgsvg.append("rect")
		.attr("x", 2)
		.attr("y", 3*lineHeight)
		.attr("width", 30)
		.attr("height", 20)
		.attr("fill","#F0F0F0");
	lgsvg.append("text")
		.attr("x", 40)
		.attr("y", 3*lineHeight+16)
		.style("font-size","16px")
		.text("无日光");
	lgsvg.append("path")
		.attr("class","tpointer")
		.attr("d","m -5,0 h 10 z m 5,-5 v 10 z")
		.attr("transform","translate("+(w*.45+18)+","+(3*lineHeight+10)+")");
	lgsvg.append("text")
		.attr("x", w*.45+40)
		.attr("y", 3*lineHeight+16)
		.style("font-size","16px")
		.text("选择时间");
}else{
	w = $(document.body).width() * 0.6;
	h = 275;
	lineHeight=25;
	$('#graph').insertAfter('#map-canvas');
	$('#chart-legend').insertBefore('#chart-svg');
	$('#map-canvas').css('width','100%');
	$('#map-canvas').css('height','300');
	$('#graph').css('float','none');
	$('#graph').css('width','100%');
	$("#chart-legend").css('float','right');
	$("#chart-legend").css('width','35%');
	$("#chart-svg").css('width','60%');
	$("#chart-svg").css('height',h+10);
	$("#simpleSearch").css('margin-right','1em');
	$("#simpleSearch").css('width',w*.48);
	var lgsvg = d3.select("#chart-legend").append("svg").attr("width",$(document.body).width()*0.35).attr("height", h-50);
	lgsvg.selectAll("rect")
		.data(Palette)
		.enter()
		.append("rect")
		.attr("x", 2)
		.attr("y", function(d,i) {return i*lineHeight;})
		.attr("width", 30)
		.attr("height", 20)
		.attr("fill", function(d) {return d;});
	lgsvg.selectAll("text")
		.data(efname)
		.enter()
		.append("text")
		.attr("x", 40)
		.attr("y", function(d,i) {return i*lineHeight+16;})
		.style("font-size","16px")
		.text(function(d) {return d;});
	lgsvg.append("g").attr("id", "lgpercent");
	lgsvg.select("#lgpercent").selectAll("text")
		.data(efname)
		.enter()
		.append("text")
		.attr("id",function(d,i) {return "tp" + i;})
		.attr("x", 125)
		.attr("y", function(d,i) {return i*lineHeight+16;})
		.style("font-size","16px")
		.style("fill","#175086")
		.text(function(d) {return "";});
	lgsvg.append("rect")
		.attr("x", 2)
		.attr("y", 6*lineHeight)
		.attr("width", 30)
		.attr("height", 20)
		.attr("fill","#F0F0F0");
	lgsvg.append("text")
		.attr("x", 40)
		.attr("y", 6*lineHeight+16)
		.style("font-size","16px")
		.text("无日光");
	lgsvg.append("path")
		.attr("class","tpointer")
		.attr("d","m -5,0 h 10 z m 5,-5 v 10 z")
		.attr("transform","translate("+18+","+(7*lineHeight+10)+")");
	lgsvg.append("text")
		.attr("x", 40)
		.attr("y", 7*lineHeight+16)
		.style("font-size","16px")
		.text("选择时间");
}

xScale = d3.scale.linear()
	.domain([0, 1439])
	.range([padding*1.5, w - padding * 1.5]);
yScale = d3.scale.linear()
	.domain([0, 364])
	.range([h - padding, padding]);
xrevScale = d3.scale.linear()
	.domain([padding*1.5, w - padding * 1.5])
	.range([0, 1439]);
yrevScale = d3.scale.linear()
	.domain([h - padding, padding])
	.range([0, 364]);

var i=0;var j=0;var k=0;
	/*$("#wallh").slider({
		orientation: "horizontal",
		range: "min",
		max: 75,
		min: 2,
		value: 20,
		slide: function(event, ui) {$("#wallh-n").text( ui.value );},
		change: function(event, ui) {$("#wallh-n").text( ui.value );AutoRedraw();}
	});
	$("#planeh").slider({
		orientation: "horizontal",
		range: "min",
		max: 50,
		min: 1,
		value: 6,
		slide: function(event, ui) {$("#planeh-n").text( ui.value );},
		change: function(event, ui) {$("#planeh-n").text( ui.value );AutoRedraw();}
	});*/
	$("#wallh").spinner({
		spin: function(event, ui) {
			if ( ui.value > 90 ) {return false;
				}else if ( ui.value < 2 ) {return false;}
			AutoRedraw();}
	});
	$("#planeh").spinner({
		spin: function(event, ui) {
			if ( ui.value > 60 ) {return false;
				}else if ( ui.value < 1 ) {return false;}
			AutoRedraw();}
	});
	$("#window").slider({
		orientation: "horizontal",
		range: "min",
		max: 100,
		min: 0,
		value: 50,
		slide: function(event, ui) {polyb.setOptions({icons: [{icon: {path: 'M 0,0 2,2', strokeOpacity: 1, strokeWeight: 2}, offset: '5px', repeat: '10px'},
			{icon: {path: 'M -1.5,-2 1.5,-2 1.5,2 -1.5,2 Z', fillColor: "#FF66D9", fillOpacity: 0.8, strokeWeight: 0},
			offset: ui.value + '%'}]});DrawLine(nowcoord,mouseDownOnElement);},
		change: function(event, ui) {
			polyb.setOptions({icons: [{icon: {path: 'M 0,0 2,2', strokeOpacity: 1, strokeWeight: 2}, offset: '5px', repeat: '10px'},
			{icon: {path: 'M -1.5,-2 1.5,-2 1.5,2 -1.5,2 Z', fillColor: "#FF66D9", fillOpacity: 0.8, strokeWeight: 0},
			offset: ui.value + '%'}]});
			AutoRedraw();}
	});
	$("#radio").buttonset();
	$("#lbradio1").click(function(){
		$("#radio1").attr("checked", "checked");
		$("#radio").buttonset('refresh');
		ChangeMarker();
		$("#btnturnw").removeClass().addClass("clr1");});
	$("#lbradio2").click(function(){
		$("#radio2").attr("checked", "checked");
		$("#radio").buttonset('refresh');
		ChangeMarker();
		$("#btnturnw").removeClass().addClass("clr2");});
	$("#btnturn").button();
	$("#btnturn").click(function(){
		if ($("#radio1").is(':checked')){
		tlatlng=markerb.getPosition();
		markerb.setPosition(markera.getPosition());
		markera.setPosition(tlatlng);
		}else{
		tlatlng=markerd.getPosition();
		markerd.setPosition(markerc.getPosition());
		markerc.setPosition(tlatlng);
		}
		});
	var xAxScale = d3.scale.linear().domain([0, 24]).range([padding*1.5, w - padding *1.5]);
	var yAxScale = d3.scale.linear().domain([1,13]).range([h - padding, padding-1]);
	var xGrScale = d3.scale.linear().domain([1, 11]).range([padding*1.5 + (w - padding *3)/12, w - padding *1.5 - (w - padding *3)/12]);
	var yGrScale = d3.scale.linear().domain([2,12]).range([h - padding - (h - padding*2)/12, padding-1 + (h - padding*2)/12]);
	var xAxis = d3.svg.axis().scale(xAxScale).orient("bottom").ticks(12)
				  .tickFormat(function(d) {if (d!=24){return d;}else{return "小时";}});
	var yAxis = d3.svg.axis().scale(yAxScale).orient("left").ticks(12)
				  .tickFormat(function(d) {if (d!=13){return d;}else{return "月";}});
	var xGrid = d3.svg.axis().scale(xGrScale).orient("top").ticks(12)
				  .tickFormat("").tickSize(h - padding*2,0);
	var yGrid = d3.svg.axis().scale(yGrScale).orient("right").ticks(12)
				  .tickFormat("").tickSize(w - padding*3,0);
	var svg = d3.select("#chart-svg").append("svg").attr("width", w).attr("height", h).on("mousedown", function() {nowcoord=d3.mouse(this);DrawLine(d3.mouse(this),true)})
	.on("mousemove", function() {if (mouseDownOnElement){nowcoord=d3.mouse(this);DrawLine(d3.mouse(this),true)}})
	.on("mouseup", function() {nowcoord=d3.mouse(this);DrawLine(d3.mouse(this),false)});
	svg.append("rect").attr("x", padding*1.5).attr("y", padding-1).attr("width", w - padding*3).attr("height", h - padding*2+1).attr("fill","#F0F0F0");
	svg.append("g").attr("id", "grapharea");
	grida=svg.append("g").attr("class", "gridarea");
	grida.append("g").attr("class", "grid gx")
		.attr("transform", "translate(0," + (h - padding) + ")").call(xGrid);
	grida.append("g").attr("class", "grid gy")
		.attr("transform", "translate(" + padding*1.5 + ",0)").call(yGrid);
	svg.append("g").attr("class", "axis ax")
		.attr("transform", "translate(0," + (h - padding) + ")").call(xAxis);
	svg.append("g").attr("class", "axis ay")
		.attr("transform", "translate(" + padding*1.5 + ",0)").call(yAxis);
	var nowDate=new Date();
	var startD = new Date(nowDate.getFullYear(), 0, 0);
	svg.append("path")
	.attr("id","tpoint")
	.attr("d","m -5,0 h 10 z m 5,-5 v 10 z")
	.attr("class","tpointer")
	.attr("transform", "translate("+xScale(nowDate.getHours()*60+nowDate.getMinutes()).toString()+","+yScale(Math.floor((nowDate-startD)/86400000)).toString()+")");
	nowcoord=[xScale(nowDate.getHours()*60+nowDate.getMinutes()),yScale(Math.floor((nowDate-startD)/86400000))];
	$(".axis text").mousedown(function(){return false});
	$(".axis text").mousemove(function(){return false});
	initialize();
});
</script>
</head>
<body>
<!--[if lt IE 10]>
<div style="border: 1px solid #FF4000; background-color: #FFDA66; text-align: center; clear: both; height: 60px; position: relative;">
<div style="position: absolute; right: 3px; top: 3px; font-family: Arial; font-weight: bold;"><a href="#" onclick='javascript:this.parentNode.parentNode.style.display="none"; return false;'>×</a></div>
<div style='margin: 0 auto; text-align: left; padding: 0; overflow: hidden; color: black; text-align:center'>
	<p style="font-size: 14px; font-weight: bold; margin-top: 12px; text-align: center;">您正在使用一款过时的浏览器。此网页可能无法使用。</p>
	<p style="font-size: 12px; margin-top: 6px; line-height: 12px; text-align: center;">请升级您的浏览器 (IE10及以上，或其他核心的最新版本浏览器) 来获得更好的浏览体验。</p>
</div>
</div>
<![endif]-->
<header>
<h1>玻璃幕墙光反射影响预测工具</h1>
</header>
<div id="app">
	<div id="simpleSearch">
		<form id="searchform" onsubmit="codeAddress();return false;">
		<input name="search" placeholder="查找地址" title="查找地址" id="address">
		<button type="submit" name="button" title="查找地址" id="searchButton" onclick="codeAddress()">
		<img id="imgsearch" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAANCAQAAAA3IEfJAAAAp0lEQVQY023PMUoDcRTE4e/9k1IwB0hEFhtLi+3TByHBO3geLyKESCoJpN/Cwj5ukQOE9OalWFjRONO93/CYiURUpm7R2uYOiBRTT370mlsYRmXh25sGtUeLaLOlmCmWucljHnNjqZhBMUbTP2pw04FLDTqwR90fa3zB0NqdeZx84MHcyfr/uqzynegHVtipXHco8lc4Rp5NsPrTKg9efGIkL6y4d3UGrfo56kDR4lwAAAAASUVORK5CYII=" alt="查找地址" width="12" height="13"></button>
		</form>
		<div class="ui-widget" id="errdiv">
			<div class="ui-state-highlight ui-corner-all" style="padding: 0 .7em;" id="error"><p></p></div>
		</div>
	</div>
	<section id="graph">
		<div id="chart-svg"></div>
		<div id="chart-legend">
			<h2>图例</h2>
		</div>
	</section>
	<section id="tools">
		<form id="radiogroup" onsubmit="return false;">
		 <span class="wigtitle">更改地图上墙面：</span><span class="jquibt"><button id="btnturn" name="btnturn"><span id="btnturnw" class="clr1">旋转墙面</span></button></span>
		<div class="jquibt" id="radio">
			<input type="radio" id="radio1" name="radio" value="wa" checked="checked"><label class="forrad" for="radio1" id="lbradio1">玻璃幕墙 <span id="distance" class="num">0</span><span class="num">米</span></label>
			<input type="radio" id="radio2" name="radio" value="wb"><label class="forrad" for="radio2" id="lbradio2">受照射墙面 <span id="distanceb" class="num">0</span><span class="num">米</span></label>
		  </div>
		</form>
		<div class="slidergroup">
		<span class="wigtitle">玻璃幕墙层数：</span>
		<input id="wallh" class="jquisp" value=20><span class="unit">层</span>
		<span class="wigtitle">受照射面楼层：</span>
		<input id="planeh" class="jquisp" value=6><span class="unit">层</span>
		<span class="wigtitle">窗：</span><div id="window" class="slider" title="调整窗在受照墙面的位置"></div></div>
	</section>
	<div id="map-canvas"></div>
</div>
<footer>
<pre id="testout"></pre>
<div class="info">
<p><span class="wigtitle">使用提示：</span>在地图上通过<strong>左右</strong>键点击或移动标识来确定目标墙体的位置。 图表<span style="background-color:#F0F0F0;padding:0 .25em;font-weight: bold;">空白</span>：标记位置不正确或无影响。 “<span class="wigtitle">窗</span>”拖动条调整窗在受照墙面的位置。</p>
<p><span class="wigtitle">说明：</span>程序会先使用粗略计算，再延时使用精确计算以提高运行速度。默认使用UTC+8时区(北京时间)显示绘图。层高为3米。程序未考虑气候、地形、建筑实际结构、遮挡物、近似的照度计算等因素，计算结果为估计的最大值。本软件的计算结果仅作参考，存在一定误差，不可用于精确测量用途。</p></div>
</footer>
</body>
</html>
